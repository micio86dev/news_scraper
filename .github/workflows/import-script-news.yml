name: Import News Script

on:
  schedule:
    - cron: "0 3 * * *" # 3:00 UTC daily
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install JS Dependencies
        run: bun install --frozen-lockfile
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt

      - name: Open SSH Tunnel to Stage MongoDB
        env:
          DO_SSH_KEY: ${{ secrets.DO_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DO_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          # Tunnel: local 27017 → VPS 27018 (mongodb-stage mapped port)
          ssh -f -N -L 27017:127.0.0.1:27018 ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }}
          echo "SSH tunnel established (local:27017 → VPS:27018 → mongodb-stage)"
          # Verify tunnel is active
          sleep 2
          if lsof -i :27017 > /dev/null 2>&1; then
            echo "✅ Tunnel is active on port 27017"
          else
            echo "❌ Tunnel failed to start"
            exit 1
          fi

      - name: Run News Scraper
        env:
          DATABASE_URL: "mongodb://${{ secrets.MONGO_ROOT_USER_STAGE }}:${{ secrets.MONGO_ROOT_PASSWORD_STAGE }}@localhost:27017/${{ secrets.MONGO_DB_NAME_STAGE }}?authSource=admin&directConnection=true"
          MONGO_DB: ${{ secrets.MONGO_DB_NAME_STAGE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RSS_FEEDS: ${{ secrets.RSS_FEEDS }}
        run: python main.py
        timeout-minutes: 30

      - name: Cleanup SSH Tunnel
        if: always()
        run: |
          pkill -f "ssh -f -N -L 27017" || true
          rm -f ~/.ssh/id_rsa
